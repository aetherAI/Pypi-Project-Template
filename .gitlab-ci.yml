include:
  - local: ci-templates/test.gitlab-ci.yml
  - local: ci-templates/publish.gitlab-ci.yml
  - template: Workflows/MergeRequest-Pipelines.gitlab-ci.yml

build:
  before_script:
    - echo "before install poetry"
    - !reference [default, before_script]

test:
  script:
    - echo "example override"
    - !reference [.test, script]

publish:
  script:
    - echo "publish as $CI_COMMIT_TAG"

update-pages:
  rules:
    - if: $CI_COMMIT_TAG && $CI_PUSH_TOKEN
  variables:
    PAGES_BRANCH_NAME: pages
  before_script: []
  script:
    - pip install sphinx sphinx-immaterial
    - sphinx-build -D version=$CI_COMMIT_TAG docs/source public/$CI_COMMIT_TAG
    - apt-get update && apt-get install -qqy git wget
    - wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
    - chmod +x /usr/bin/yq
    - git config --global user.email $GITLAB_USER_EMAIL
    - git config --global user.name $GITLAB_USER_NAME
    - git remote set-url origin "https://${GITLAB_USER_NAME}:${CI_PUSH_TOKEN}@gitlab.com/$CI_PROJECT_PATH.git"
    - git branch -D $PAGES_BRANCH_NAME || true
    - git checkout --orphan $PAGES_BRANCH_NAME
    - git rm -rf .
    - |-
      if [[ $(git ls-remote --heads origin $PAGES_BRANCH_NAME) ]]; then
        echo "find existing branch '${PAGES_BRANCH_NAME}'"
        git pull origin $PAGES_BRANCH_NAME
      else
        echo "no branch named '${PAGES_BRANCH_NAME}', do initialization"
        echo "[]" > public/versions.json
        echo "/${CI_PROJECT_NAME}/ /${CI_PROJECT_NAME}/${CI_COMMIT_TAG}" > public/_redirects
        yq -n '
          .pages.image = "python:3.7"
          | .pages.script[0] = "echo \"generate pages\""
          | .pages.artifact.paths[0] = "public"
        ' > .gitlab-ci.yml
      fi
    - |
      v=$CI_COMMIT_TAG yq -i -o json '. += [{
        "version": strenv(v),
        "title": strenv(v),
        "aliases": []}]
      ' public/versions.json
    - git add public .gitlab-ci.yml
    - git commit -m "Add version $CI_COMMIT_TAG"
    - git push --set-upstream origin $PAGES_BRANCH_NAME
