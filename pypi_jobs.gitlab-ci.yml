.upload_pypi_template:
  stage: deploy
  variables:
    POETRY_VERSION: "==1.1.*"
    PUBLISH_ARGS: ""
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - python -V
    - pip install "poetry${POETRY_VERSION}"
    - echo $CI_COMMIT_TAG
    - poetry version $CI_COMMIT_TAG
    - poetry publish --build -r $CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/pypi -u gitlab-ci-token -p $CI_JOB_TOKEN $PUBLISH_ARGS

.trigger_master_generate_badge_template:
  stage: .post
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - curl --request POST --form token=$CI_JOB_TOKEN --form ref=$CI_DEFAULT_BRANCH "$CI_API_V4_URL/projects/$CI_PROJECT_ID/trigger/pipeline"

.generate_badge_template:
  stage: .post
  image: registry.aetherai.com/docker-hub/library/python:3.7.6
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      when: always
  variables:
    PIP_EXTRA_INDEX_URL: "https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/api/v4/groups/364078/-/packages/pypi/simple"
    SUCCESS_BADGE_COLOR: green
    FAIL_BADGE_COLOR: red
  script:
    - pip install -U pip
    - pip install anybadge toml
    - package_name=$(python -c "import toml; print(toml.load('pyproject.toml')['tool']['poetry']['name'])")
    - echo $package_name
    - latest_version=$((pip install ${package_name}==notexist 2>&1 || true) | grep versions | awk '{ gsub(/\)/, ""); print $NF }')
    - echo $latest_version
    - color=$( [[ $latest_version = none ]] && echo $FAIL_BADGE_COLOR || echo $SUCCESS_BADGE_COLOR)
    - anybadge -l pypi -v $latest_version -f package_badge.svg -c $color -o
  artifacts:
    paths:
      - package_badge.svg
    expire_in: 4 weeks

upload_pypi:
  extends: .upload_pypi_template

test_upload_pypi:
  extends: .upload_pypi_template
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    PUBLISH_ARGS: "--dry-run"

trigger_master_generate_badge:
  extends: .trigger_master_generate_badge_template

generate_badge:
  extends: .generate_badge_template
