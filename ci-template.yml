upload_pypi:
  stage: deploy
  only:
    - tags
  script:
    - python -V
    - pip install poetry twine
    - echo $CI_COMMIT_TAG
    - poetry version $CI_COMMIT_TAG
    - poetry build
    - TWINE_PASSWORD=$CI_JOB_TOKEN TWINE_USERNAME=gitlab-ci-token twine upload --repository-url $CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/pypi dist/*

trigger_master_generate_badge:
  stage: .post
  only:
    - tags
  script:
    - curl --request POST --form token=$CI_JOB_TOKEN --form ref=$CI_DEFAULT_BRANCH "$CI_API_V4_URL/projects/$CI_PROJECT_ID/trigger/pipeline"

generate_badge:
  stage: .post
  image: python3.7
  only:
    - $CI_DEFAULT_BRANCH
  when:
    - always
  script:
    - pip install -U pip
    - pip install anybadge toml
    - export PIP_EXTRA_INDEX_URL="https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/api/v4/groups/364078/-/packages/pypi/simple"
    - package_name=$(python -c "import toml; print(toml.load('pyproject.toml')['tool']['poetry']['name'])")
    - echo $package_name
    - latest_version=$((pip install ${package_name}==notexist 2>&1 || true) | grep versions | awk '{print substr($NF, 0, length($NF) - 1)}')
    - echo $latest_version
    - color=$( [[ $latest_version = none ]] && echo 'red' || echo 'green')
    - anybadge -l pypi -v $latest_version -f package_badge.svg -c $color -o
  artifacts:
    paths:
      - package_badge.svg
    expire_in: 4 weeks
