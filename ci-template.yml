upload_pypi:
  stage: release
  only:
    - tags
  before_script:
    - python -V
    - pip install poetry
  script:
    - echo $CI_COMMIT_TAG
    - poetry version $CI_COMMIT_TAG
    - poetry build
    - TWINE_PASSWORD=$CI_JOB_TOKEN TWINE_USERNAME=gitlab-ci-token poetry run python3 -m twine upload --repository-url https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/packages/pypi dist/*

trigger_master_generate_badge:
  stage: postrelease
  only:
    - tags
  script:
    - curl --request POST --form "token=$CI_JOB_TOKEN" --form ref=master "$CI_API_V4_URL/projects/$CI_PROJECT_ID/trigger/pipeline"

generate_badge:
  stage: postrelease
  only:
    - master
  before_script:
    - pip install -U pip
    - pip install anybadge toml
  script:
    - export PIP_EXTRA_INDEX_URL="https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/api/v4/groups/364078/-/packages/pypi/simple"
    - curl $CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/files/generate_badge.py\?ref\=master -H 'PRIVATE-TOKEN $CI_JOB_TOKEN'
    - python generate_badge.py package_badge.svg
  artifacts:
    paths:
      - package_badge.svg
    expire_in: 4 weeks
